@startuml
actor User
participant "User Device" as DEVICE
participant "UI" as FE
participant "API" as C
participant "Service" as S
participant "FCM" as FCM
database "Database" as DB

activate User
User -> FE : Grant notification permission
activate FE
FE -> FCM : Request FCM token
activate FCM
FCM --> FE : Return FCM token
deactivate FCM
FE -> C : POST /notification/token { token }
deactivate FE
activate C
C -> S : saveFcmToken(token)
activate S
S -> S : Get authenticated UID
S -> DB : Update user record with FCM token
activate DB
DB --> S : success
deactivate DB
S --> C : OK
deactivate S
C --> FE : 200 OK
activate FE
FE -> User : Token saved
deactivate C
deactivate User

FE -> C : POST /notification/send { NotificationDTO }
deactivate FE
activate C
C -> S : sendNotification(NotificationDTO)
activate S
S -> S : Get authenticated UID
S -> DB : Get user's FCM token
activate DB
DB --> S : Return token
deactivate DB
S -> FCM : Send message (token, title, body)
activate FCM
FCM --> S : Delivery response
deactivate FCM
S --> C : OK
deactivate S
C --> FE : 200 OK
activate FE
FE -> DEVICE : Trigger OS/browser push notification
activate DEVICE
DEVICE -> User : Display push notification
deactivate DEVICE
activate User
FE -> User : Display in-app notification
deactivate FE
deactivate User
@enduml
